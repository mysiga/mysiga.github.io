<!DOCTYPE html>
<html lang="cn">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Wilson" />



<meta name="description" content="扯扯线程并发和同步的那些事 2015.6.26线程基础的那些事——李仙鹏线程线程俗称为轻量级进程。在现代OS中，通常以线程作为基本的调度单位。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程又有各自的程序计数器、栈以及局部变量等。因此，再配合多核CPU，多个线程方可被并发执行。 线程的上下文切换如果当前运行线程数与CPU核数相同，那么这些线程将不会被系统调度出去。 但是，如果可运行的">
<meta name="keywords" content="线程,同步异步">
<meta property="og:type" content="article">
<meta property="og:title" content="扯扯线程并发和同步的那些事">
<meta property="og:url" content="http://yoursite.com/2015/06/27/移动组周技术分享-线程并发和同步/index.html">
<meta property="og:site_name" content="Wilson">
<meta property="og:description" content="扯扯线程并发和同步的那些事 2015.6.26线程基础的那些事——李仙鹏线程线程俗称为轻量级进程。在现代OS中，通常以线程作为基本的调度单位。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程又有各自的程序计数器、栈以及局部变量等。因此，再配合多核CPU，多个线程方可被并发执行。 线程的上下文切换如果当前运行线程数与CPU核数相同，那么这些线程将不会被系统调度出去。 但是，如果可运行的">
<meta property="og:image" content="http://www.51cto.com/files/uploadimg/20061010/1202170.gif">
<meta property="og:updated_time" content="2016-08-23T00:59:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="扯扯线程并发和同步的那些事">
<meta name="twitter:description" content="扯扯线程并发和同步的那些事 2015.6.26线程基础的那些事——李仙鹏线程线程俗称为轻量级进程。在现代OS中，通常以线程作为基本的调度单位。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程又有各自的程序计数器、栈以及局部变量等。因此，再配合多核CPU，多个线程方可被并发执行。 线程的上下文切换如果当前运行线程数与CPU核数相同，那么这些线程将不会被系统调度出去。 但是，如果可运行的">
<meta name="twitter:image" content="http://www.51cto.com/files/uploadimg/20061010/1202170.gif">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Wilson" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>扯扯线程并发和同步的那些事 | Wilson</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Wilson</a></h1>
        </hgroup>

        
        <p class="header-subtitle">爱折腾的技术男</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUnit4/">JUnit4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Playground/">Playground</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog-tools-ci/">blog, tools, ci</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javaScript/">javaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phython/">phython</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tablayout/">tablayout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weui/">weui</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客/">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/同步异步/">同步异步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/坑/">坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发效率/">开发效率</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/效率/">效率</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/游戏/">游戏</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/研发杂谈/">研发杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程/">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站/">网站</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Wilson</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Wilson</a></h1>
            </hgroup>
            
            <p class="header-subtitle">爱折腾的技术男</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-移动组周技术分享-线程并发和同步" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/27/移动组周技术分享-线程并发和同步/" class="article-date">
      <time datetime="2015-06-26T23:04:29.000Z" itemprop="datePublished">2015-06-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      扯扯线程并发和同步的那些事
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/同步异步/">同步异步</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/线程/">线程</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="扯扯线程并发和同步的那些事-2015-6-26"><a href="#扯扯线程并发和同步的那些事-2015-6-26" class="headerlink" title="扯扯线程并发和同步的那些事 2015.6.26"></a>扯扯线程并发和同步的那些事 2015.6.26</h2><h3 id="线程基础的那些事——李仙鹏"><a href="#线程基础的那些事——李仙鹏" class="headerlink" title="线程基础的那些事——李仙鹏"></a>线程基础的那些事——李仙鹏</h3><h4 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h4><p>线程俗称为轻量级进程。在现代OS中，通常以线程作为基本的调度单位。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程又有各自的程序计数器、栈以及局部变量等。因此，再配合多核CPU，多个线程方可被并发执行。</p>
<h5 id="线程的上下文切换"><a href="#线程的上下文切换" class="headerlink" title="线程的上下文切换"></a>线程的上下文切换</h5><p>如果当前运行线程数与CPU核数相同，那么这些线程将不会被系统调度出去。</p>
<p>但是，如果可运行的线程数量大于CPU核数，那么系统会通过上下文切换，将某个正在运行的线程调度出来，从而使其他线程能够获得CPU的时间片，从而得到运行。</p>
<p><strong>上下文切换需要一定的开销：</strong></p>
<ol>
<li>系统和应用程序都使用一组相同的CPU，线程调度需要访问系统资源。系统代码消耗越多的CPU时间，分配到应用程序的可用CPU时间就越少。</li>
<li>上下文切换会导致处理器的一些缓存缺失</li>
</ol>
<blockquote>
<p>线程的以上特性，促使了现代编程的并发和同步问题：</p>
<ul>
<li>安全性问题。安全性的含义是“永远不会发生糟糕的事情”</li>
<li>活跃性问题。活跃性关注的目标为“某件正确的事情最终会发生”</li>
<li>性能问题。性能关注的点事“正确的事情尽快发生”</li>
</ul>
</blockquote>
<h4 id="超线程（Hyper-Threading）"><a href="#超线程（Hyper-Threading）" class="headerlink" title="超线程（Hyper-Threading）"></a>超线程（Hyper-Threading）</h4><p>为何我们会经常听到宣传说：四核八线程并行（如I5处理器）、八核十六线程并行（如I7）。原因是，这些CPU使用了超线程技术。超线程最早由因特尔研发，并在奔腾四处理器将技术主流化。</p>
<p>超线程技术是在CPU内部仅复制必要的资源、让CPU模拟成两个线程；也就是一个实体核心，两个逻辑线程，在一单位时间内处理两个线程的工作，模拟实体双核心、双线程运作。</p>
<p>虽然采用超线程技术能同时执行两个线程，但它并不象两个真正的CPU那样，每个CPU都具有独立的资源。当两个线程都同时需要某一个资源时，其中一个要暂时停止，并让出资源，直到这些资源闲置后才能继续。因此超线程的性能并不等于两颗CPU的性能。</p>
<h4 id="GUI为什么都是单线程"><a href="#GUI为什么都是单线程" class="headerlink" title="GUI为什么都是单线程"></a>GUI为什么都是单线程</h4><p>许多人曾经尝试过编写多线程的GUI来处理事件，但最终都由于竞态条件和死锁导致的稳定性而重回到单线程的事件队列模型：使用UI线程从队列中抽取事件，并将事件分发给事件处理器（消费者）。</p>
<p>另一个重要原因是MVC会导致多线程的GUI因为不一致的锁定顺序而发生死锁。<br><img src="http://www.51cto.com/files/uploadimg/20061010/1202170.gif" alt="MVC模式图"></p>
<h4 id="推荐两本书"><a href="#推荐两本书" class="headerlink" title="推荐两本书"></a>推荐两本书</h4><blockquote>
<p><strong>值得一看：</strong></p>
<ul>
<li><a href="http://book.douban.com/subject/5333562/" target="_blank" rel="external">深入理解计算机系统</a></li>
<li><a href="http://book.douban.com/subject/10484692/" target="_blank" rel="external">Java并发编程实战</a></li>
</ul>
</blockquote>
<h3 id="JAVA多线程中的单例——贾学涛"><a href="#JAVA多线程中的单例——贾学涛" class="headerlink" title="JAVA多线程中的单例——贾学涛"></a>JAVA多线程中的单例——贾学涛</h3><h4 id="常见单利模写法"><a href="#常见单利模写法" class="headerlink" title="常见单利模写法"></a>常见单利模写法</h4><pre><code>public class Singleton {  

    private static Singleton mInstance；

    private Singleton(){
    }

    public static Singleton getInstance(){
        if (mInstance == null) {
            mInstance = new Singleton();
        }
        return mInstance;
    }
}
</code></pre><ul>
<li>缺点：非线程安全的，在多线程并发的情况下容易出现多个实例存在的情况</li>
</ul>
<h4 id="改为线程安全的单例模式"><a href="#改为线程安全的单例模式" class="headerlink" title="改为线程安全的单例模式"></a>改为线程安全的单例模式</h4><p>通过添加synchronized关键字  </p>
<pre><code>public class Singleton {  

    private static Singleton mInstance；

    private Singleton(){
    }

    public static synchronized Singleton getInstance(){
        if (mInstance == null) {
            mInstance = new Singleton();
        }
        return mInstance;
    }
}
</code></pre><ul>
<li>缺点：每次都要进行同步检查，实际上需要检查的时机是在首次创建实例的时候。</li>
</ul>
<h4 id="改为双重检查锁单例模式"><a href="#改为双重检查锁单例模式" class="headerlink" title="改为双重检查锁单例模式"></a>改为双重检查锁单例模式</h4><pre><code>public class Singleton {  

    private static Singleton mInstance；

    private Singleton(){
    }

    public static Singleton getInstance(){
        if (mInstance == null) {          //Single Checked
            synchronized(Singleton.class) {
                if (mInstance == null) {        //Double Checked
                    mInstance = new Singleton();
                }
            }
        }
        return mInstance;
    }
}
</code></pre><ul>
<li><p>instance = new Singleton()这句，并非是一个原子操作，事实上在 JVM 中这句话大概做了下面 3 件事情  </p>
<blockquote>
<p>1.给 instance 分配内存<br>2.调用 Singleton 的构造函数来初始化成员变量<br>3.将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）  </p>
</blockquote>
<p>  但是在 JVM 的即时编译器中存在指令重排序的优化。也就是说上面的第二步和第三步的顺序是不能保证的.可能会出现第一次检测是mInstance为非null时，有可能实例还未创建。所以线程二会直接返回 instance，然后使用，然后顺理成章地报错。</p>
</li>
</ul>
<h4 id="为实例变量增加volatile关键字"><a href="#为实例变量增加volatile关键字" class="headerlink" title="为实例变量增加volatile关键字"></a>为实例变量增加volatile关键字</h4><pre><code>public class Singleton {  

    private volatile static Singleton mInstance；    // 增加volatile关键字

    private Singleton(){
    }

    public static Singleton getInstance(){
        if (mInstance == null) {          //Single Checked
            synchronized(Singleton.class) {
                if (mInstance == null) {        //Double Checked
                    mInstance = new Singleton();
                }
            }
        }
        return mInstance;
    }
}
</code></pre><ul>
<li><p>使用 volatile 的主要原因是其另一个特性：禁止指令重排序优化。也就是说，在 volatile 变量的赋值操作后面会有一个内存屏障，读操作不会被重排序到内存屏障之前</p>
</li>
<li><p>Java 5 以前的版本使用了 volatile 的双检锁还是有问题的。其原因是 Java 5 以前的 JMM （Java 内存模型）是存在缺陷的，即时将变量声明成 volatile 也不能完全避免重排序</p>
</li>
</ul>
<h4 id="饿汉加载单例模式"><a href="#饿汉加载单例模式" class="headerlink" title="饿汉加载单例模式"></a>饿汉加载单例模式</h4><pre><code>public class Singleton {  

    private static Singleton mInstance ＝ new Singleton()；

    private Singleton(){
    }

    public static Singleton getInstance(){
        return mInstance;
    }
}
</code></pre><p>变种的饿汉加载单例模式</p>
<pre><code>public class Singleton {

    private static Singleton mInstance；

    static {
        mInstance = new Singleton();
    }

    private Singleton(){
    }

    public static Singleton getInstance(){
        return mInstance;
    }
}
</code></pre><ul>
<li>缺点：在类被加载的时候就会去创建实例，牺牲空间来保证时间，与之前的单例模式相反，懒汉加载是牺牲时间，来保证空间，在需要的时候再去创建实例。</li>
</ul>
<h4 id="通过静态内部类来创建单例"><a href="#通过静态内部类来创建单例" class="headerlink" title="通过静态内部类来创建单例"></a>通过静态内部类来创建单例</h4><pre><code>public class Singleton {

    private Singleton(){
    }

    public static Singleton getInstance(){
        return InnerClass.mInstance;
    }

    private staitc class InnerClass{
        public static Singleton mInstance = new Singleton();
    }
}
</code></pre><ul>
<li>与前者一样，通过classloader机制来保证线程安全，区别是，前者当Singleton类被加载时，就会创建实例，而后者是在需要调用getInstance的时候去加载内部类的时候，来创建实例。</li>
</ul>
<h4 id="通过枚举来创建单例"><a href="#通过枚举来创建单例" class="headerlink" title="通过枚举来创建单例"></a>通过枚举来创建单例</h4><pre><code>public enum Singleton {
    INSTANCE;
}
</code></pre><p>访问实例对象 Singleton.INSTANCE</p>
<p>*默认枚举实例的创建是线程安全的，但是在枚举中的其他任何方法由程序员自己负责。</p>
<h3 id="为什么要有线程同步之喂金鱼问题——曾铭"><a href="#为什么要有线程同步之喂金鱼问题——曾铭" class="headerlink" title="为什么要有线程同步之喂金鱼问题——曾铭"></a>为什么要有线程同步之喂金鱼问题——曾铭</h3><h4 id="喂金鱼问题"><a href="#喂金鱼问题" class="headerlink" title="喂金鱼问题"></a>喂金鱼问题</h4><ul>
<li>金鱼一天不吃会饿死，一天吃两次会撑死；</li>
<li>张三、李四，每天每人分别会去执行这件事一次；</li>
</ul>
<h4 id="方案-1"><a href="#方案-1" class="headerlink" title="方案 1"></a>方案 1</h4><p>两人执行一致</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">if</span> (<span class="literal">no</span>Feed) &#123;</div><div class="line">	<span class="attribute">feed</span> fish</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>张三</th>
<th>李四</th>
</tr>
</thead>
<tbody>
<tr>
<td>if (noFeed) {</td>
<td>.</td>
</tr>
<tr>
<td>.</td>
<td>if (noFeed) {</td>
</tr>
<tr>
<td>.</td>
<td>feed fish</td>
</tr>
<tr>
<td>feed fish</td>
<td>.</td>
</tr>
<tr>
<td>fish died</td>
<td>.</td>
</tr>
</tbody>
</table>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><ul>
<li>feed fish 时间越长，鱼被撑死可能性越大</li>
<li>没解决问题</li>
</ul>
<h4 id="方案-2"><a href="#方案-2" class="headerlink" title="方案 2"></a>方案 2</h4><p>两人执行一致</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">if</span> (<span class="literal">no</span>Note) &#123;</div><div class="line">	<span class="attribute">leave</span> note</div><div class="line"></div><div class="line">	if (<span class="literal">no</span>Feed) &#123;</div><div class="line">		<span class="attribute">feed</span> fish</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	remove note</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>张三</th>
<th>李四</th>
</tr>
</thead>
<tbody>
<tr>
<td>if (noNote) {</td>
<td>.</td>
</tr>
<tr>
<td>.</td>
<td>if (noNote) {</td>
</tr>
<tr>
<td>.</td>
<td>leave note</td>
</tr>
<tr>
<td>leave note</td>
<td>.</td>
</tr>
<tr>
<td>if (noFeed) {</td>
<td>.</td>
</tr>
<tr>
<td>.</td>
<td>if (noFeed) {</td>
</tr>
<tr>
<td>.</td>
<td>feed fish</td>
</tr>
<tr>
<td>feed fish</td>
<td>.</td>
</tr>
<tr>
<td>fish died</td>
<td>.</td>
</tr>
</tbody>
</table>
<h5 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h5><ul>
<li>noNote, noFeed 按特定顺序执行才会出问题</li>
<li>noNote 多了一层保护，如果 leave note 时间很短，出问题可能性很小</li>
<li>没解决问题</li>
</ul>
<h4 id="方案-3"><a href="#方案-3" class="headerlink" title="方案 3"></a>方案 3</h4><p>张三执行</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">leave <span class="symbol">note3</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="comment">(noNote4)</span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="comment">(noFeed)</span> &#123;</div><div class="line">		feed fish</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">remove <span class="symbol">note3</span></div></pre></td></tr></table></figure>
<p>李四执行</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">leave <span class="symbol">note4</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="comment">(noNote3)</span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="comment">(noFeed)</span> &#123;</div><div class="line">		feed fish</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">remove <span class="symbol">note4</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>张三</th>
<th>李四</th>
</tr>
</thead>
<tbody>
<tr>
<td>leave note3</td>
<td>.</td>
</tr>
<tr>
<td>.</td>
<td>leave note4</td>
</tr>
<tr>
<td>.</td>
<td>if (noNote3) {</td>
</tr>
<tr>
<td>if (noNote4) {</td>
<td>.</td>
</tr>
<tr>
<td>remove note3</td>
<td>.</td>
</tr>
<tr>
<td>.</td>
<td>remove note4</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>fish died</td>
<td>.</td>
</tr>
</tbody>
</table>
<h5 id="结论-2"><a href="#结论-2" class="headerlink" title="结论"></a>结论</h5><ul>
<li>不会被撑死了，可能会被饿死……</li>
<li>没解决问题</li>
</ul>
<h4 id="方案-4"><a href="#方案-4" class="headerlink" title="方案 4"></a>方案 4</h4><p>张三执行</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">leave <span class="symbol">note3</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="comment">(noNote4)</span></div><div class="line">&#123;</div><div class="line">	sleep <span class="comment">(1)</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="comment">(noFeed)</span> &#123;</div><div class="line">	feed fish</div><div class="line">&#125;</div><div class="line"></div><div class="line">remove <span class="symbol">note3</span></div></pre></td></tr></table></figure>
<p>李四执行</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">leave <span class="symbol">note4</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="comment">(noNote3)</span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="comment">(noFeed)</span> &#123;</div><div class="line">		feed fish</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">remove <span class="symbol">note4</span></div></pre></td></tr></table></figure>
<h5 id="结论-3"><a href="#结论-3" class="headerlink" title="结论"></a>结论</h5><ul>
<li>的确解决了问题</li>
<li>能优化么？<ul>
<li>程序不不对称</li>
<li>循环等待的浪费</li>
</ul>
</li>
</ul>
<h4 id="方案-5"><a href="#方案-5" class="headerlink" title="方案 5"></a>方案 5</h4><p>两人执行一致</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">lock</span><span class="params">()</span></span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (noFeed) &#123;</div><div class="line">	feed fish</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">unlock</span><span class="params">()</span></span></div></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul>
<li>能解决问题</li>
<li>程序对称</li>
<li>持有锁需要等待，未解决浪费问题<ul>
<li>生产者与消费者问题</li>
</ul>
</li>
</ul>
<h4 id="END"><a href="#END" class="headerlink" title="END"></a>END</h4><p><strong>全部内容来自<a href="http://book.douban.com/subject/3670621/" target="_blank" rel="external">《计算机的心智·操作系统之哲学原理》——邹恒明</a> 第七章</strong></p>
<h3 id="iOS并发相关的概念介绍——潘君"><a href="#iOS并发相关的概念介绍——潘君" class="headerlink" title="iOS并发相关的概念介绍——潘君"></a>iOS并发相关的概念介绍——潘君</h3><p>@(归纳中)[iOS]</p>
<h4 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h4><p>#####竞态条件<br>竞态条件（race condition），从多进程间通信的角度来讲，是指两个或多个进程对共享的数据进行读或写的操作时，最终的结果取决于这些进程的执行顺序。<br>竞态条件（race condition）是指设备或系统出现不恰当的执行时序，而得到不正确的结果。</p>
<p>注: <code>atomic</code> 可以解决竞态竞争 但是无法保证类是<code>线程安全</code>的</p>
<h4 id="iOS中的相关概念"><a href="#iOS中的相关概念" class="headerlink" title="iOS中的相关概念"></a>iOS中的相关概念</h4><p>#####atomic属性</p>
<blockquote>
<p>property 修饰符</p>
</blockquote>
<p>加了atomic后生成的setter,类似如下代码:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)setProp:<span class="type"></span>(NSString *)<span class="keyword">new</span><span class="type">Value</span> &#123;</div><div class="line">    [_prop lock];</div><div class="line">    _prop = <span class="keyword">new</span><span class="type">Value</span>;</div><div class="line">    [_prop unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#####@synchronized指令</p>
<blockquote>
<p>引用自<a href="http://www.xuebuyuan.com/1682784.html" target="_blank" rel="external">@synchronized(id anObject) ｛｝定义和使用</a><br>1.作用：创建了一个互斥锁，它的作用和其他语言中的互斥锁作用一样</p>
<p>2.解释：这个是OBC中的一个锁定令牌，防止｛｝里的内容在同一时间内被其他线程访问，起到了线程保护的作用</p>
<p>3.使用范围：一般在单例模式或者操作类的static变量的时候使用，即共用的变量的时候</p>
<p>4.外延：这个令牌隐式的包含了异常处理，如果你不想使用的话，就使用锁吧</p>
<p>5.它的参数是id类型，如果用<br>@synchronized(1) {<br>}<br>编译器提示<br>@synchronzied requires an Objective-C object type.<br>也就是说需要一个objective C的对象类型。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@synchronized(id anObject)</span>&#123;</div><div class="line">	 <span class="comment">// test code</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#####NSLock</p>
<p>使用样例:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//主线程中</span></div><div class="line">TestObj *obj = [[TestObj alloc] init];</div><div class="line">NSLock *<span class="built_in">lock</span> = [[NSLock alloc] init];</div><div class="line"></div><div class="line"><span class="comment">//线程1</span></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">    [<span class="built_in">lock</span> <span class="built_in">lock</span>];</div><div class="line">    [obj method1];</div><div class="line">    <span class="built_in">sleep</span>(<span class="number">10</span>);</div><div class="line">    [<span class="built_in">lock</span> unlock];</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//线程2</span></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);<span class="comment">//以保证让线程2的代码后执行</span></div><div class="line">    [<span class="built_in">lock</span> <span class="built_in">lock</span>];</div><div class="line">    [obj method2];</div><div class="line">    [<span class="built_in">lock</span> unlock];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>###<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html" target="_blank" rel="external">iOS多线程</a> - 杨志平</p>
<p>####简介</p>
<p>iOS有三种多线程编程的技术，分别是：</p>
<ul>
<li><h4 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread"></a>NSThread</h4></li>
<li><h4 id="Cocoa-NSOperation"><a href="#Cocoa-NSOperation" class="headerlink" title="Cocoa NSOperation"></a>Cocoa NSOperation</h4></li>
<li><h4 id="GCD-（全称：Grand-Central-Dispatch）"><a href="#GCD-（全称：Grand-Central-Dispatch）" class="headerlink" title="GCD （全称：Grand Central Dispatch）"></a>GCD <strong><em>（全称：Grand Central Dispatch）</em></strong></h4></li>
</ul>
<blockquote>
<p> <em>这三种编程方式从上到下，抽象度层次是从低到高的，抽象度越高的使用越简单，也是Apple最推荐使用的</em></p>
</blockquote>
<h4 id="三种方式的介绍："><a href="#三种方式的介绍：" class="headerlink" title="三种方式的介绍："></a>三种方式的介绍：</h4><h5 id="NSThread-文档"><a href="#NSThread-文档" class="headerlink" title="NSThread - 文档"></a>NSThread - <a href="https://developer.apple.com/library/prerelease/ios/documentation/Cocoa/Reference/Foundation/Classes/NSThread_Class/" target="_blank" rel="external">文档</a></h5><blockquote>
<p>优点：NSThread 比其他两个轻量级<br>缺点：需要自己管理线程的生命周期，线程同步。线程同步对数据的加锁会有一定的系统开销</p>
</blockquote>
<h5 id="NSOperation-文档"><a href="#NSOperation-文档" class="headerlink" title="NSOperation - 文档"></a>NSOperation - <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/NSOperation_class/" target="_blank" rel="external">文档</a></h5><blockquote>
<p>优点：不需要关心线程管理，数据同步的事情，可以把精力放在自己需要执行的操作上。<br>创建NSOperation子类的对象，把对象添加到NSOperationQueue队列里执行。</p>
</blockquote>
<h5 id="GCD-文档"><a href="#GCD-文档" class="headerlink" title="GCD - 文档"></a>GCD - <a href="https://developer.apple.com/library/prerelease/ios/documentation/Performance/Reference/GCD_libdispatch_Ref/index.html" target="_blank" rel="external">文档</a></h5><blockquote>
<p>Grand Central Dispatch (GCD)是Apple开发的一个多核编程的解决方法。在iOS4.0开始之后才能使用。GCD是一个替代诸如NSThread, NSOperationQueue, NSInvocationOperation等技术的很高效和强大的技术。</p>
<p>GCD的底层依然是用线程实现，不过这样可以让程序员不用关注实现的细节。</p>
</blockquote>
<h4 id="创建线程的开销-查看文档"><a href="#创建线程的开销-查看文档" class="headerlink" title="创建线程的开销 - 查看文档"></a>创建线程的开销 - <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Multithreading/CreatingThreads/CreatingThreads.html" target="_blank" rel="external">查看文档</a></h4><table>
<thead>
<tr>
<th>Item</th>
<th>Approximate cost</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kernel data structures</td>
<td>Approximately 1 KB</td>
<td>This memory is used to store the thread data structures and attributes, much of which is allocated as wired memory and therefore cannot be paged to disk.</td>
</tr>
<tr>
<td>Stack space</td>
<td>512 KB (secondary threads)  8 MB (OS X main thread)  1 MB (iOS main thread)</td>
<td>The minimum allowed stack size for secondary threads is 16 KB and the stack size must be a multiple of 4 KB. The space for this memory is set aside in your process space at thread creation time, but the actual pages associated with that memory are not created until they are needed.</td>
</tr>
<tr>
<td>Creation time</td>
<td>Approximately 90 microseconds</td>
<td>This value reflects the time between the initial call to create the thread and the time at which the thread’s entry point routine began executing. The figures were determined by analyzing the mean and median values generated during thread creation on an Intel-based iMac with a 2 GHz Core Duo processor and 1 GB of RAM running OS X v10.5.</td>
</tr>
</tbody>
</table>
<h4 id="替代线程的一些技术"><a href="#替代线程的一些技术" class="headerlink" title="替代线程的一些技术"></a>替代线程的一些技术</h4><table>
<thead>
<tr>
<th>Item</th>
<th>Approximate cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Operation objects</td>
<td>Introduced in OS X v10.5, an operation object is a wrapper for a task that would normally be executed on a secondary thread. This wrapper hides the thread management aspects of performing the task, leaving you free to focus on the task itself. You typically use these objects in conjunction with an operation queue object, which actually manages the execution of the operation objects on one or more threads.For more information on how to use operation objects, see <a href="https://developer.apple.com/library/mac/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091" target="_blank" rel="external">Concurrency Programming Guide</a>.</td>
</tr>
<tr>
<td>Grand Central Dispatch (GCD)</td>
<td>Introduced in Mac OS x v10.6, Grand Central Dispatch is another alternative to threads that lets you focus on the tasks you need to perform rather than on thread management. With GCD, you define the task you want to perform and add it to a work queue, which handles the scheduling of your task on an appropriate thread. Work queues take into account the number of available cores and the current load to execute your tasks more efficiently than you could do yourself using threads.For information on how to use GCD and work queues, see <a href="https://developer.apple.com/library/mac/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091" target="_blank" rel="external">Concurrency Programming Guide</a></td>
</tr>
<tr>
<td>Idle-time notifications</td>
<td>For tasks that are relatively short and very low priority, idle time notifications let you perform the task at a time when your application is not as busy. Cocoa provides support for idle-time notifications using the NSNotificationQueue object. To request an idle-time notification, post a notification to the default <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNotificationQueue_Class/index.html#//apple_ref/occ/cl/NSNotificationQueue" target="_blank" rel="external">NSNotificationQueue</a> object using the <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNotificationQueue_Class/index.html#//apple_ref/c/econst/NSPostWhenIdle" target="_blank" rel="external">NSPostWhenIdle</a> option. The queue delays the delivery of your notification object until the run loop becomes idle. For more information, see <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Notifications/Introduction/introNotifications.html#//apple_ref/doc/uid/10000043i" target="_blank" rel="external">Notification Programming Topics</a>.</td>
</tr>
<tr>
<td>Asynchronous functions</td>
<td>The system interfaces include many asynchronous functions that provide automatic concurrency for you. These APIs may use system daemons and processes or create custom threads to perform their task and return the results to you. (The actual implementation is irrelevant because it is separated from your code.) As you design your application, look for functions that offer asynchronous behavior and consider using them instead of using the equivalent synchronous function on a custom thread</td>
</tr>
<tr>
<td>Timers</td>
<td>You can use timers on your application’s main thread to perform periodic tasks that are too trivial to require a thread, but which still require servicing at regular intervals. For information on timers, see <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW21" target="_blank" rel="external">Timer Sources</a></td>
</tr>
<tr>
<td>Separate processes</td>
<td>Although more heavyweight than threads, creating a separate process might be useful in cases where the task is only tangentially related to your application. You might use a process if a task requires a significant amount of memory or must be executed using root privileges. For example, you might use a 64-bit server process to compute a large data set while your 32-bit application displays the results to the user</td>
</tr>
</tbody>
</table>
<h4 id="线程安全-文档"><a href="#线程安全-文档" class="headerlink" title="线程安全 - 文档"></a>线程安全 - <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/ThreadSafetySummary/ThreadSafetySummary.html#//apple_ref/doc/uid/10000057i-CH12-SW1" target="_blank" rel="external">文档</a></h4><h5 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h5><ul>
<li>Immutable objects are generally thread-safe. Once you create them, you can safely pass these objects to and from threads. On the other hand, mutable objects are generally not thread-safe. To use mutable objects in a threaded application, the application must synchronize appropriately.</li>
<li>Many objects deemed “thread-unsafe” are only unsafe to use from multiple threads. Many of these objects can be used from any thread as long as it is only one thread at a time. Objects that are specifically restricted to the main thread of an application are called out as such</li>
<li>The main thread of the application is responsible for handling events. Although the Application Kit continues to work if other threads are involved in the event path, operations can occur out of sequence</li>
<li>If you want to use a thread to draw to a view, bracket all drawing code between the <strong><em>lockFocusIfCanDraw</em></strong> and <strong><em>unlockFocus</em></strong> methods of NSView</li>
</ul>
<h5 id="Thread-Safe-Classes-and-Functions"><a href="#Thread-Safe-Classes-and-Functions" class="headerlink" title="Thread-Safe Classes and Functions"></a>Thread-Safe Classes and Functions</h5><p>The following classes and functions are generally considered to be thread-safe. You can use the same instance from multiple threads without first acquiring a lock.</p>
<blockquote>
<p>NSArray<br>NSAssertionHandler<br>NSAttributedString<br>NSCalendarDate<br>NSCharacterSet<br>NSConditionLock<br>NSConnection<br>NSData<br>NSDate<br>NSDecimal functions<br>NSDecimalNumber<br>NSDecimalNumberHandler<br>NSDeserializer<br>NSDictionary<br>NSDistantObject<br>NSDistributedLock<br>NSDistributedNotificationCenter<br>NSException<br>NSFileManager (in OS X v10.5 and later)<br>NSHost<br>NSLock<br>NSLog/NSLogv<br>NSMethodSignature<br>NSNotification<br>NSNotificationCenter<br>NSNumber<br>NSObject<br>NSPortCoder<br>NSPortMessage<br>NSPortNameServer<br>NSProtocolChecker<br>NSProxy<br>NSRecursiveLock<br>NSSet<br>NSString<br>NSThread<br>NSTimer<br>NSTimeZone<br>NSUserDefaults<br>NSValue</p>
</blockquote>
<h5 id="Thread-Unsafe-Classes"><a href="#Thread-Unsafe-Classes" class="headerlink" title="Thread-Unsafe Classes"></a>Thread-Unsafe Classes</h5><p>The following classes and functions are generally not thread-safe. In most cases, you can use these classes from any thread as long as you use them from only one thread at a time.</p>
<blockquote>
<p>NSArchiver<br>NSAutoreleasePool<br>NSBundle<br>NSCalendar<br>NSCoder<br>NSCountedSet<br>NSDateFormatter<br>NSEnumerator<br>NSFileHandle<br>NSFormatter<br>NSHashTable functions<br>NSInvocation<br>NSJavaSetup functions<br>NSMapTable functions<br>NSMutableArray<br>NSMutableAttributedString<br>NSMutableCharacterSet<br>NSMutableData<br>NSMutableDictionary<br>NSMutableSet<br>NSMutableString<br>NSNotificationQueue<br>NSNumberFormatter<br>NSPipe<br>NSPort<br>NSProcessInfo<br>NSRunLoop<br>NSScanner<br>NSSerializer<br>NSTask<br>NSUnarchiver<br>NSUndoManager</p>
</blockquote>
<p>#####Main Thread Only Classes</p>
<p>The following class must be used only from the main thread of an application.</p>
<blockquote>
<p>NSAppleScript</p>
</blockquote>
<h3 id="多线程的死锁-张超耀"><a href="#多线程的死锁-张超耀" class="headerlink" title="多线程的死锁 - 张超耀"></a>多线程的死锁 - 张超耀</h3><ul>
<li>俗话说，人多好办事！在程序里也是这样，如果是同一个应用程序需要并行处理多件任务，那就可以创建多条线程。但是人多了，往往会出现冲突，使得这个工作无法再进行下去了(正所谓三个和尚没水喝)，这就是“死锁”。</li>
</ul>
<h4 id="死锁的产生"><a href="#死锁的产生" class="headerlink" title="死锁的产生"></a>死锁的产生</h4><ul>
<li><a href="http://baike.baidu.com/link?url=OgOrpH_xTP7U0C0tM59aBhq83uaKe0Ck9MQEL1G41A3q-D1hVuynm3ra-U93RoQICKbmqhs7nTuCoN_elydnr_" target="_blank" rel="external">哲学家进餐问题</a></li>
</ul>
<p><strong>那么我们如何来消除“死锁”呢？首先，让我们来看看产生“死锁”的必要条件：</strong></p>
<ul>
<li><p>互斥：就是说多个线程不能同时使用同一资源</p>
</li>
<li><p>请求和保持：就是某线程必须同时拥有多个资源才能完成任务，否则它将占用已经拥有的资源直到拥有他所需的所有资源为止</p>
</li>
<li><p>不剥夺：就是说所有线程的优先级都相同，不能在别的线程没有释放资源的情况下，夺走其已占有的资源</p>
</li>
<li><p>循环等待，就是没有资源满足的线程无限期地等待</p>
</li>
</ul>
<p><strong>有的朋友可能已经明白了，只要打破这这几个必要条件，就能打破“死锁”！</strong></p>
<ul>
<li><p>互斥：就是要让多个线程能共享资源</p>
</li>
<li><p>请求和保持：只要当检测到自己所需的资源仍被别的线程占用，即释放自己已占有的资源（毫不利己，专门利人），或者在经过一段时间的等待后，还未得到所需资源，才释放，这都能打破请求和保持</p>
</li>
<li><p>不剥夺：只要给线程制定一个优先级即可</p>
</li>
<li><p>最后的循环等待的解决方法其实和<code>请求和保持</code>是一样的，都是等待一段时间后释放资源。</p>
</li>
</ul>
<p><strong>好了，希望通过这个例子能让不了解死锁的朋友对“死锁”能有一定的认识</strong></p>
<h2 id="集合的并行操作-王胜"><a href="#集合的并行操作-王胜" class="headerlink" title="集合的并行操作 - 王胜"></a>集合的并行操作 - 王胜</h2><p>用for循环操作一个集合，即读取集合元素，同时又删除集合中的元素，会发生什么事情呢？</p>
<p>上代码【号外，号外，此示例来源于我们项目中的真实代码哦~】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Target class</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Target</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> id;<span class="comment">// ID</span></div><div class="line">	String type;<span class="comment">// 类型</span></div><div class="line">	<span class="keyword">int</span> count;<span class="comment">// 未读消息数</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Target</span><span class="params">(<span class="keyword">int</span> id, String type, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.type = type;</div><div class="line">		<span class="keyword">this</span>.count = count;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Target [id="</span> + id + <span class="string">", type="</span> + type + <span class="string">", count="</span> + count + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 以下是模拟一组target集合，target包含group、room、user类型。</span></div><div class="line">List&lt;Target&gt; sessions = <span class="keyword">new</span> ArrayList&lt;Target&gt;();</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">1</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">2</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">3</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">4</span>, <span class="string">"room"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">5</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">6</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">7</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">8</span>, <span class="string">"user"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">9</span>, <span class="string">"user"</span>, <span class="number">1</span>));</div><div class="line">sessions.add(<span class="keyword">new</span> Target(<span class="number">10</span>, <span class="string">"group"</span>, <span class="number">1</span>));</div><div class="line">System.out.println(<span class="string">"before size:"</span>+sessions.size()+<span class="string">", sessions:"</span>+humanPrintList(sessions));</div><div class="line"><span class="keyword">int</span> totalUnread = <span class="number">0</span>;<span class="comment">// 统计集合中类型为group的target未读消息数量</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;sessions.size();i++) &#123;</div><div class="line">	System.out.println(<span class="string">"read index:"</span> + i + <span class="string">", session:"</span>+sessions.get(i));</div><div class="line">	<span class="keyword">if</span> (sessions.get(i).type.equals(<span class="string">"group"</span>)) &#123;<span class="comment">// 如果是group类型，则累加未读消息数</span></div><div class="line">		System.out.println(<span class="string">"==&gt; add totalUnread"</span>);</div><div class="line">		totalUnread += sessions.get(i).count;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;<span class="comment">// 否则，将target移除集合</span></div><div class="line">		System.out.println(<span class="string">"==&gt; remove"</span>);</div><div class="line">		sessions.remove(i);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">System.out.println(<span class="string">"after size:"</span>+sessions.size()+<span class="string">", totalUnread:"</span>+totalUnread+<span class="string">",sessions:"</span>+humanPrintList(sessions));</div></pre></td></tr></table></figure>
<p>至此，示例代码结束。大家可以猜测下最后的输出中sessions的长度，内容以及总共的未读消息数据。</p>
<p>项目中的代码，期望结果是剩余集合只包含group类型的target，而且totalUnread的值是类型为group的target的未读消息数之和。可是，运行的结果却是：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">before <span class="built_in">size</span>:<span class="number">10</span>, sessions:</div><div class="line">========== List content: ===========</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">1</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">2</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">3</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">4</span>, <span class="keyword">type</span>=room, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">5</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">6</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">7</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">8</span>, <span class="keyword">type</span>=user, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">9</span>, <span class="keyword">type</span>=user, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">10</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">====================================</div><div class="line">read <span class="built_in">index</span>:<span class="number">0</span>, session:<span class="keyword">Target</span> [id=<span class="number">1</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">read <span class="built_in">index</span>:<span class="number">1</span>, session:<span class="keyword">Target</span> [id=<span class="number">2</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">read <span class="built_in">index</span>:<span class="number">2</span>, session:<span class="keyword">Target</span> [id=<span class="number">3</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">read <span class="built_in">index</span>:<span class="number">3</span>, session:<span class="keyword">Target</span> [id=<span class="number">4</span>, <span class="keyword">type</span>=room, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; remove</div><div class="line">read <span class="built_in">index</span>:<span class="number">4</span>, session:<span class="keyword">Target</span> [id=<span class="number">6</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">read <span class="built_in">index</span>:<span class="number">5</span>, session:<span class="keyword">Target</span> [id=<span class="number">7</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">read <span class="built_in">index</span>:<span class="number">6</span>, session:<span class="keyword">Target</span> [id=<span class="number">8</span>, <span class="keyword">type</span>=user, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; remove</div><div class="line">read <span class="built_in">index</span>:<span class="number">7</span>, session:<span class="keyword">Target</span> [id=<span class="number">10</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">==&gt; add totalUnread</div><div class="line">after <span class="built_in">size</span>:<span class="number">8</span>, totalUnread:<span class="number">6</span>,sessions:</div><div class="line">========== List content: ===========</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">1</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">2</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">3</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">5</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">6</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">7</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">9</span>, <span class="keyword">type</span>=user, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line"><span class="keyword">Target</span> [id=<span class="number">10</span>, <span class="keyword">type</span>=group, <span class="built_in">count</span>=<span class="number">1</span>]</div><div class="line">====================================</div></pre></td></tr></table></figure>
<p>为什么结果完全不是预期的呢？原因是程序走到else时，将元素移除，后面的元素自动往前移动，所以继续取下一个下标时，被移除的后一个元素悄悄溜走了，成了漏网之鱼。</p>
<p><strong>解决方法</strong> : 最简单的就是在remove后执行 <code>i--;</code></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2015/06/27/移动组周技术分享-线程并发和同步/">扯扯线程并发和同步的那些事</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Wilson</a></p>
        <p><span>发布时间:</span>2015-06-26, 23:04:29</p>
        <p><span>最后更新:</span>2016-08-23, 08:59:40</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2015/06/27/移动组周技术分享-线程并发和同步/" title="扯扯线程并发和同步的那些事">http://yoursite.com/2015/06/27/移动组周技术分享-线程并发和同步/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2015/06/27/移动组周技术分享-线程并发和同步/　　作者: Wilson" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2015/07/08/移动组周技术分享-知其所以然/">
                    知其所以然
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2015/06/20/移动组周技术分享-代码效率/">
                    代码开发效率提升方法
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#扯扯线程并发和同步的那些事-2015-6-26"><span class="toc-number">1.</span> <span class="toc-text">扯扯线程并发和同步的那些事 2015.6.26</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线程基础的那些事——李仙鹏"><span class="toc-number">1.1.</span> <span class="toc-text">线程基础的那些事——李仙鹏</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#线程"><span class="toc-number">1.1.1.</span> <span class="toc-text">线程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#线程的上下文切换"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">线程的上下文切换</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#超线程（Hyper-Threading）"><span class="toc-number">1.1.2.</span> <span class="toc-text">超线程（Hyper-Threading）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GUI为什么都是单线程"><span class="toc-number">1.1.3.</span> <span class="toc-text">GUI为什么都是单线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#推荐两本书"><span class="toc-number">1.1.4.</span> <span class="toc-text">推荐两本书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JAVA多线程中的单例——贾学涛"><span class="toc-number">1.2.</span> <span class="toc-text">JAVA多线程中的单例——贾学涛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常见单利模写法"><span class="toc-number">1.2.1.</span> <span class="toc-text">常见单利模写法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#改为线程安全的单例模式"><span class="toc-number">1.2.2.</span> <span class="toc-text">改为线程安全的单例模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#改为双重检查锁单例模式"><span class="toc-number">1.2.3.</span> <span class="toc-text">改为双重检查锁单例模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为实例变量增加volatile关键字"><span class="toc-number">1.2.4.</span> <span class="toc-text">为实例变量增加volatile关键字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#饿汉加载单例模式"><span class="toc-number">1.2.5.</span> <span class="toc-text">饿汉加载单例模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过静态内部类来创建单例"><span class="toc-number">1.2.6.</span> <span class="toc-text">通过静态内部类来创建单例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过枚举来创建单例"><span class="toc-number">1.2.7.</span> <span class="toc-text">通过枚举来创建单例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要有线程同步之喂金鱼问题——曾铭"><span class="toc-number">1.3.</span> <span class="toc-text">为什么要有线程同步之喂金鱼问题——曾铭</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#喂金鱼问题"><span class="toc-number">1.3.1.</span> <span class="toc-text">喂金鱼问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">方案 1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#结论"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">方案 2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#结论-1"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-3"><span class="toc-number">1.3.4.</span> <span class="toc-text">方案 3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#结论-2"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-4"><span class="toc-number">1.3.5.</span> <span class="toc-text">方案 4</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#结论-3"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方案-5"><span class="toc-number">1.3.6.</span> <span class="toc-text">方案 5</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#总结"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#END"><span class="toc-number">1.3.7.</span> <span class="toc-text">END</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS并发相关的概念介绍——潘君"><span class="toc-number">1.4.</span> <span class="toc-text">iOS并发相关的概念介绍——潘君</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基础概念"><span class="toc-number">1.4.1.</span> <span class="toc-text">基础概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iOS中的相关概念"><span class="toc-number">1.4.2.</span> <span class="toc-text">iOS中的相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSThread"><span class="toc-number">1.4.3.</span> <span class="toc-text">NSThread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cocoa-NSOperation"><span class="toc-number">1.4.4.</span> <span class="toc-text">Cocoa NSOperation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GCD-（全称：Grand-Central-Dispatch）"><span class="toc-number">1.4.5.</span> <span class="toc-text">GCD （全称：Grand Central Dispatch）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三种方式的介绍："><span class="toc-number">1.4.6.</span> <span class="toc-text">三种方式的介绍：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NSThread-文档"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">NSThread - 文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSOperation-文档"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">NSOperation - 文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GCD-文档"><span class="toc-number">1.4.6.3.</span> <span class="toc-text">GCD - 文档</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建线程的开销-查看文档"><span class="toc-number">1.4.7.</span> <span class="toc-text">创建线程的开销 - 查看文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#替代线程的一些技术"><span class="toc-number">1.4.8.</span> <span class="toc-text">替代线程的一些技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程安全-文档"><span class="toc-number">1.4.9.</span> <span class="toc-text">线程安全 - 文档</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#原则"><span class="toc-number">1.4.9.1.</span> <span class="toc-text">原则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Thread-Safe-Classes-and-Functions"><span class="toc-number">1.4.9.2.</span> <span class="toc-text">Thread-Safe Classes and Functions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Thread-Unsafe-Classes"><span class="toc-number">1.4.9.3.</span> <span class="toc-text">Thread-Unsafe Classes</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多线程的死锁-张超耀"><span class="toc-number">1.5.</span> <span class="toc-text">多线程的死锁 - 张超耀</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#死锁的产生"><span class="toc-number">1.5.1.</span> <span class="toc-text">死锁的产生</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集合的并行操作-王胜"><span class="toc-number">2.</span> <span class="toc-text">集合的并行操作 - 王胜</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"扯扯线程并发和同步的那些事　| Wilson　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2015/07/08/移动组周技术分享-知其所以然/" title="上一篇: 知其所以然">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2015/06/20/移动组周技术分享-代码效率/" title="下一篇: 代码开发效率提升方法">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/07/29/移动周分享-第61期/">移动周分享-第61期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/移动周分享-第60期/">移动周分享-第60期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/15/移动周分享-第59期/">移动周分享-第59期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/移动周分享-第58期/">移动周分享-第58期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/27/移动周分享-第57期/">移动周分享-第57期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/20/移动周分享-第56期/">移动周分享-第56期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/13/移动周分享-第55期/">移动周分享-第55期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/06/移动周分享-第54期/">移动周分享-第54期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/29/移动周分享-第53期/">移动周分享-第53期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/22/移动周分享-第52期/">移动周分享-第52期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/08/移动周分享-第50期/">移动周分享-第50期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/移动周分享-第49期/">移动周分享-第49期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/18/移动周分享-第48期/">移动周分享-第48期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/11/移动周分享-第47期/">移动周分享-第47期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/04/移动周分享-第46期/">移动周分享-第46期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/26/移动周分享-第45期/">移动周分享-第45期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/移动周分享-第44期/">移动周分享-第44期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/29/移动周分享-第43期/">移动周分享-第43期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/15/移动周分享-第42期/">移动周分享-第42期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/07/Why-Git-Learn-It/">Why Git? Learn It!</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/25/移动周分享-第41期/">移动周分享-第41期</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/18/移动周分享-第40期/">移动周分享-第40期</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/11/周精益分享- 前端入门篇2期/">周精益分享 - 前端入门篇2期</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/周精益分享- 前端入门篇/">周精益分享 - 前端入门篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/25/周精益分享-后端开发/">周精益分享 - 后端开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/18/周精益分享-动画/">周精益分享 - 动画</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/13/周精益分享-Swift入门专题/">周精益分享 - Swift入门专题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/04/周精益分享-装逼指南二期/">周精益分享 - 程序员装逼指南二期</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/30/2015-10-30-周精益分享-程序员装逼指南/">周精益分享 - 程序员装逼指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/23/周精益分享-英语/">周精益分享 - 英语</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/16/2015-10-16-谈谈未来，职业规划，梦想/">周精益分享-谈谈未来、梦想、职业规划</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/25/周精益分享-设计规范交流 /">周精益分享-设计规范交流</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/19/周精益分享-自由主题 /">周精益分享-自由主题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/14/周精益分享-自由主题/">周精益分享-自由主题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/21/那些年我们用过的第三方库/">那些年我们用过的第三方库</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/14/ 聊聊提高代码质量/">聊聊提高代码质量</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/07/ 随意“无主题”/">无主题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/31/网络信息安全/">网络信息安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/27/上海-Android-小伙伴一起来-51offer-玩吧/">[上海] Android 小伙伴一起来 51offer 玩吧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/24/2015-07-24简单谈谈计算机网络/">简单谈谈计算机网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/17/移动组周技术分享-研发路上的那些事儿/">移动组周技术分享-研发路上的那些事儿</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/11/用-travis-ci-自动部署-hexo-静态博客/">用 travis-ci 自动部署 hexo 静态博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/10/移动组周技术分享-微信公众号开发/">微信公众号开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/08/移动组周技术分享-知其所以然/">知其所以然</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/27/移动组周技术分享-线程并发和同步/">扯扯线程并发和同步的那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/20/移动组周技术分享-代码效率/">代码开发效率提升方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/13/移动组周技术分享-开源/">开源</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/06/移动组周技术分享-博客/">博客分享主题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/30/移动组周技术分享-游戏开发/">游戏开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/23/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/16/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/09/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/25/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/18/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/11/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/04/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/28/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/21/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/14/移动组周技术分享/">《无主题》</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/07/移动组周技术分享/">《无主题》</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Wilson
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>